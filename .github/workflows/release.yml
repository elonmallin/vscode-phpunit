name: Create GitHub Release and Publish Extension

permissions:
  contents: write

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

jobs:
  create_release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Download Artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: release-artifact.yml
          branch: master
          name: release-artifact
          path: release-artifact

      - name: Copy vsix to workspace dir
        run: cp release-artifact/* .

      - name: Check Tag Version
        run: |
          artifact=$(find release-artifact -name "phpunit-*.vsix")
          tag_version=$(echo "${{ github.ref }}" | sed -e 's/refs\/tags\///' -e 's/v//')
          artifact_version=$(echo "${artifact}" | sed 's/.*phpunit-\(.*\)\.vsix/\1/')
          if [ "${tag_version}" != "${artifact_version}" ]; then
            echo "Tag version ${tag_version} does not match artifact version ${artifact_version}. Cancelling pipeline."
            exit 1
          fi

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: phpunit-*.vsix
          prerelease: ${{ contains(github.ref, '-') }}

      - name: Prerelease Extension
        if: contains(github.ref, '-')
        run: npx vsce publish --pre-release
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      # - name: Publish Extension
      #   if: !contains(github.ref, '-')
      #   run: npm run deploy
      #   env:
      #     VSCE_PAT: ${{ secrets.VSCE_PAT }}
